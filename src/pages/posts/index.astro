---
import { getPostsData } from "../../api/posts";
import Header from "../../components/Header.astro";
import PinnedPost from "../../components/PinnedPost.astro";
import MainLayout from "../../layouts/Main.astro";
import PostLayout from "../../layouts/Post.astro";
import { frontmatter } from "../../utils/markdown";

const topic = Astro.url.searchParams.get("topic");

// clean up empty URL param
if (!topic && Astro.url.searchParams.has("topic")) {
  return Astro.redirect("/posts");
}

let { pinnedPost, posts, topics } = await getPostsData(50, { topic });
---

<MainLayout
  title="Oleksandr Sh. content"
  description="Sharing ideas about Software Engineering, Web Development, and Life of an Indie hacker through text, code and memes."
>
  <header class="bg-primary text-on-primary">
    <PostLayout>
      <Header backLink="/"><b slot="back-link">Home</b></Header>
    </PostLayout>
  </header>
  <main>
    <div class="bg-primary text-on-primary flex flex-col justify-between">
      <PostLayout>
        <h1 class="mb-12 text-7xl font-bold">Posts</h1>
        {pinnedPost && <PinnedPost post={pinnedPost} />}
      </PostLayout>
    </div>
    <PostLayout>
      <ul class="flex max-w-full flex-row gap-2 overflow-auto pl-2.5">
        <li
          class="p-2 font-light decoration-2 underline-offset-2 hover:underline"
        >
          <a href="?topic=">All</a>
        </li>
        {
          topics.map((topic) => {
            const name = topic.name.slice(topic.name.indexOf(":") + 1);
            return (
              <li class="p-2 font-light decoration-2 underline-offset-2 hover:underline">
                <a href={`?topic=${name}`}>{name}</a>
              </li>
            );
          })
        }
      </ul>
      <ul class="flex flex-col gap-4">
        {
          posts.map((post) => {
            const data = frontmatter({ body: post.body });
            return (
              <li>
                <a
                  href={`/posts/${post.number}`}
                  class="text-on-background flex flex-col gap-2 rounded-xl p-4"
                >
                  <img
                    src={data.poster}
                    alt={data.posterAlt}
                    class="max-h-32 w-auto self-start rounded-xl"
                  />
                  <span class="text-xl">{post.title}</span>
                  <p class="text-md hidden sm:block">{data.description}</p>
                </a>
              </li>
            );
          })
        }
      </ul>
    </PostLayout>
  </main>
</MainLayout>
